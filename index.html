<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
        <meta charset="utf-8">
        <title>Croquet Maker</title>
        <script id="croquetScript type="text/javascript" src="./croquet.min.js"></script>
        <script type="module">
            // this part of code identifies what renkon application, including renkon-pad as default,
            // to load.
            // 1) When there is a ?pad= option, and the option ends with ".json" or ".renkon" and
            //    the (partial) URL, that .json or .renkon is used as the top level app.
            // 2) When the .html file name is other than "index.html", the basename for the .html file
            //    is used to construct a path "./${basename}.renkon", and it is used as the top-level app.
            // 3) otherwise (no ?pad=, or the HTML is named "index.html"), the bootstrap version of renkon-pad
            //    in pad.js is loaded.

            // it could be renkon-core.js here, though it is just handy to use a package
            // with CodeMirror bundled.
            import {ProgramState, newInspector, globals} from "./renkon-web.js";
            import {CodeMirror, CodeMirrorModel, CodeMirrorView} from "./codemirror.js";
            import {croquetify, splitStrs, toFunction, loader} from "./croquet.js";
            window.CodeMirror = CodeMirror;
            window.CodeMirrorModel = CodeMirrorModel;
            window.CodeMirrorView = CodeMirrorView;
            window.RenkonWeb = {newInspector, globals};
            window.CodeMirror = CodeMirror;
            window.ProgramState = ProgramState;
            const programState = new ProgramState(Date.now());
            window.RenkonWeb = {globals};

            // for debugging purpose, store the current programState to window
            window.programState = programState;

            function launcher() {
                const pathname = window.location.pathname;
                const match = /^.*\/([^/]*)\.html?$/.exec(pathname);
                let basename = match ? match[1] : "index";
                const url = new URL(window.location);
                const padOption = url.searchParams.get("pad");
                const bootstrap = url.searchParams.get("bootstrap");

                if (bootstrap) {
                    // bootstrap version if this file name is index.html and the file? padOption is not specified
                    programState.setupProgram([`
                        const {pad} = import("./pad.js");
                        console.log("default renkon-pad is starting");
                    Renkon.merge(pad);`]);
                    programState.evaluate(Date.now());
                    return;
                }

                let docName = `${basename}.renkon`;
                if (padOption) {
                    if (padOption.endsWith(".json") || padOption.endsWith(".renkon")) {
                        docName = padOption;
                    } else {
                        console.log("pad option does not have .renkon suffix.")
                        return;
                    }
                }

                const q = url.searchParams.get("q");

                const options = {};

                if (q) {
                  options.appParameters.name = q;
                  if (url.hash && url.has.beginsWith("pw=")) {
                    options.appParameters.password = url.hash.slice("pw=".length) || "abc";
                  }
                } else {
                  options.additionalDebug = ["offline"];
                }

                loader(docName, ProgramState, options);
            }
            window.onload = launcher;
        </script>
    </head>
    <body></body>
</html>
